{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.37.4.10188",
      "templateHash": "3975132354192383883"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "defaultValue": "prod",
      "metadata": {
        "description": "Environment name (dev, staging, prod)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "appName": {
      "type": "string",
      "defaultValue": "auditapp",
      "metadata": {
        "description": "Application name prefix"
      }
    },
    "uniqueSuffix": {
      "type": "string",
      "defaultValue": "[uniqueString(resourceGroup().id)]",
      "metadata": {
        "description": "Unique suffix for globally unique names"
      }
    },
    "useExistingAISearch": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Use existing AI Search service instead of creating new"
      }
    },
    "existingAISearchName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing AI Search service name (if useExistingAISearch is true)"
      }
    },
    "existingAISearchRG": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing AI Search resource group (if useExistingAISearch is true)"
      }
    },
    "useExistingStorage": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Use existing Storage Account instead of creating new"
      }
    },
    "existingStorageAccountName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing Storage Account name (if useExistingStorage is true)"
      }
    },
    "existingStorageAccountRG": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing Storage Account resource group (if useExistingStorage is true)"
      }
    }
  },
  "variables": {
    "resourcePrefix": "[format('{0}-{1}', parameters('appName'), parameters('environment'))]",
    "tags": {
      "Environment": "[parameters('environment')]",
      "Application": "AuditApp",
      "ManagedBy": "Bicep"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Sql/servers",
      "apiVersion": "2023-02-01-preview",
      "name": "[format('{0}-sql-{1}', variables('resourcePrefix'), parameters('uniqueSuffix'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "administratorLogin": "sqladmin",
        "administratorLoginPassword": "P@ssw0rd123!",
        "version": "12.0",
        "minimalTlsVersion": "1.2",
        "publicNetworkAccess": "Enabled"
      }
    },
    {
      "type": "Microsoft.Sql/servers/databases",
      "apiVersion": "2023-02-01-preview",
      "name": "[format('{0}/{1}', format('{0}-sql-{1}', variables('resourcePrefix'), parameters('uniqueSuffix')), format('{0}-db', variables('resourcePrefix')))]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "sku": {
        "name": "[if(equals(parameters('environment'), 'prod'), 'S1', 'Basic')]",
        "tier": "[if(equals(parameters('environment'), 'prod'), 'Standard', 'Basic')]"
      },
      "properties": {
        "collation": "SQL_Latin1_General_CP1_CI_AS",
        "maxSizeBytes": 2147483648
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', format('{0}-sql-{1}', variables('resourcePrefix'), parameters('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Sql/servers/firewallRules",
      "apiVersion": "2023-02-01-preview",
      "name": "[format('{0}/{1}', format('{0}-sql-{1}', variables('resourcePrefix'), parameters('uniqueSuffix')), 'AllowAzureServices')]",
      "properties": {
        "startIpAddress": "0.0.0.0",
        "endIpAddress": "0.0.0.0"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', format('{0}-sql-{1}', variables('resourcePrefix'), parameters('uniqueSuffix')))]"
      ]
    },
    {
      "condition": "[not(parameters('useExistingStorage'))]",
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-01-01",
      "name": "[format('{0}st{1}', replace(variables('resourcePrefix'), '-', ''), parameters('uniqueSuffix'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {
        "accessTier": "Hot",
        "supportsHttpsTrafficOnly": true,
        "minimumTlsVersion": "TLS1_2"
      }
    },
    {
      "condition": "[not(parameters('useExistingStorage'))]",
      "type": "Microsoft.Storage/storageAccounts/blobServices",
      "apiVersion": "2023-01-01",
      "name": "[format('{0}/{1}', format('{0}st{1}', replace(variables('resourcePrefix'), '-', ''), parameters('uniqueSuffix')), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}st{1}', replace(variables('resourcePrefix'), '-', ''), parameters('uniqueSuffix')))]"
      ]
    },
    {
      "condition": "[not(parameters('useExistingStorage'))]",
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2023-01-01",
      "name": "[format('{0}/{1}/{2}', format('{0}st{1}', replace(variables('resourcePrefix'), '-', ''), parameters('uniqueSuffix')), 'default', format('audit-{0}-documents', parameters('environment')))]",
      "properties": {
        "publicAccess": "None"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', format('{0}st{1}', replace(variables('resourcePrefix'), '-', ''), parameters('uniqueSuffix')), 'default')]"
      ]
    },
    {
      "condition": "[not(parameters('useExistingStorage'))]",
      "type": "Microsoft.Storage/storageAccounts/queueServices",
      "apiVersion": "2023-01-01",
      "name": "[format('{0}/{1}', format('{0}st{1}', replace(variables('resourcePrefix'), '-', ''), parameters('uniqueSuffix')), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}st{1}', replace(variables('resourcePrefix'), '-', ''), parameters('uniqueSuffix')))]"
      ]
    },
    {
      "condition": "[not(parameters('useExistingStorage'))]",
      "type": "Microsoft.Storage/storageAccounts/queueServices/queues",
      "apiVersion": "2023-01-01",
      "name": "[format('{0}/{1}/{2}', format('{0}st{1}', replace(variables('resourcePrefix'), '-', ''), parameters('uniqueSuffix')), 'default', format('audit-{0}-processing', parameters('environment')))]",
      "properties": {},
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/queueServices', format('{0}st{1}', replace(variables('resourcePrefix'), '-', ''), parameters('uniqueSuffix')), 'default')]"
      ]
    },
    {
      "condition": "[not(parameters('useExistingAISearch'))]",
      "type": "Microsoft.Search/searchServices",
      "apiVersion": "2023-11-01",
      "name": "[format('{0}-search-{1}', variables('resourcePrefix'), parameters('uniqueSuffix'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "sku": {
        "name": "[if(equals(parameters('environment'), 'prod'), 'standard', 'basic')]"
      },
      "properties": {
        "replicaCount": "[if(equals(parameters('environment'), 'prod'), 2, 1)]",
        "partitionCount": 1,
        "hostingMode": "default",
        "publicNetworkAccess": "enabled"
      }
    },
    {
      "type": "Microsoft.Cache/redis",
      "apiVersion": "2023-08-01",
      "name": "[format('{0}-redis-{1}', variables('resourcePrefix'), parameters('uniqueSuffix'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "sku": {
          "name": "[if(equals(parameters('environment'), 'prod'), 'Standard', 'Basic')]",
          "family": "C",
          "capacity": "[if(equals(parameters('environment'), 'prod'), 1, 0)]"
        },
        "enableNonSslPort": false,
        "minimumTlsVersion": "1.2",
        "redisConfiguration": {
          "maxmemory-policy": "allkeys-lru"
        }
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-07-01",
      "name": "[format('{0}-kv-{1}', variables('resourcePrefix'), parameters('uniqueSuffix'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "sku": {
          "family": "A",
          "name": "standard"
        },
        "tenantId": "[subscription().tenantId]",
        "enableRbacAuthorization": true,
        "enableSoftDelete": true,
        "softDeleteRetentionInDays": 7
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2023-09-01",
      "name": "[format('{0}-logs-{1}', variables('resourcePrefix'), parameters('uniqueSuffix'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "sku": {
          "name": "PerGB2018"
        },
        "retentionInDays": 30
      }
    },
    {
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02",
      "name": "[format('{0}-insights', variables('resourcePrefix'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "kind": "web",
      "properties": {
        "Application_Type": "web",
        "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs-{1}', variables('resourcePrefix'), parameters('uniqueSuffix')))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs-{1}', variables('resourcePrefix'), parameters('uniqueSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.ContainerRegistry/registries",
      "apiVersion": "2023-07-01",
      "name": "[format('{0}acr{1}', replace(variables('resourcePrefix'), '-', ''), parameters('uniqueSuffix'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "sku": {
        "name": "Basic"
      },
      "properties": {
        "adminUserEnabled": true
      }
    },
    {
      "type": "Microsoft.App/managedEnvironments",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}-containerenv', variables('resourcePrefix'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "appLogsConfiguration": {
          "destination": "log-analytics",
          "logAnalyticsConfiguration": {
            "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs-{1}', variables('resourcePrefix'), parameters('uniqueSuffix'))), '2023-09-01').customerId]",
            "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs-{1}', variables('resourcePrefix'), parameters('uniqueSuffix'))), '2023-09-01').primarySharedKey]"
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-logs-{1}', variables('resourcePrefix'), parameters('uniqueSuffix')))]"
      ]
    }
  ],
  "outputs": {
    "sqlServerName": {
      "type": "string",
      "value": "[format('{0}-sql-{1}', variables('resourcePrefix'), parameters('uniqueSuffix'))]"
    },
    "sqlDatabaseName": {
      "type": "string",
      "value": "[format('{0}-db', variables('resourcePrefix'))]"
    },
    "sqlConnectionString": {
      "type": "string",
      "value": "[format('Server=tcp:{0},1433;Initial Catalog={1};Persist Security Info=False;User ID=sqladmin;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;', reference(resourceId('Microsoft.Sql/servers', format('{0}-sql-{1}', variables('resourcePrefix'), parameters('uniqueSuffix'))), '2023-02-01-preview').fullyQualifiedDomainName, format('{0}-db', variables('resourcePrefix')))]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[if(parameters('useExistingStorage'), parameters('existingStorageAccountName'), format('{0}st{1}', replace(variables('resourcePrefix'), '-', ''), parameters('uniqueSuffix')))]"
    },
    "storageConnectionString": {
      "type": "string",
      "value": "[if(parameters('useExistingStorage'), format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix=core.windows.net', parameters('existingStorageAccountName'), listKeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingStorageAccountRG')), 'Microsoft.Storage/storageAccounts', parameters('existingStorageAccountName')), '2023-01-01').keys[0].value), format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix=core.windows.net', format('{0}st{1}', replace(variables('resourcePrefix'), '-', ''), parameters('uniqueSuffix')), listKeys(resourceId('Microsoft.Storage/storageAccounts', format('{0}st{1}', replace(variables('resourcePrefix'), '-', ''), parameters('uniqueSuffix'))), '2023-01-01').keys[0].value))]"
    },
    "searchServiceName": {
      "type": "string",
      "value": "[if(parameters('useExistingAISearch'), parameters('existingAISearchName'), format('{0}-search-{1}', variables('resourcePrefix'), parameters('uniqueSuffix')))]"
    },
    "searchEndpoint": {
      "type": "string",
      "value": "[if(parameters('useExistingAISearch'), format('https://{0}.search.windows.net', parameters('existingAISearchName')), format('https://{0}.search.windows.net', format('{0}-search-{1}', variables('resourcePrefix'), parameters('uniqueSuffix'))))]"
    },
    "searchApiKey": {
      "type": "string",
      "value": "[if(parameters('useExistingAISearch'), listAdminKeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingAISearchRG')), 'Microsoft.Search/searchServices', parameters('existingAISearchName')), '2023-11-01').primaryKey, listAdminKeys(resourceId('Microsoft.Search/searchServices', format('{0}-search-{1}', variables('resourcePrefix'), parameters('uniqueSuffix'))), '2023-11-01').primaryKey)]"
    },
    "redisHostName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Cache/redis', format('{0}-redis-{1}', variables('resourcePrefix'), parameters('uniqueSuffix'))), '2023-08-01').hostName]"
    },
    "redisConnectionString": {
      "type": "string",
      "value": "[format('{0}:6380,password={1},ssl=True,abortConnect=False', reference(resourceId('Microsoft.Cache/redis', format('{0}-redis-{1}', variables('resourcePrefix'), parameters('uniqueSuffix'))), '2023-08-01').hostName, listKeys(resourceId('Microsoft.Cache/redis', format('{0}-redis-{1}', variables('resourcePrefix'), parameters('uniqueSuffix'))), '2023-08-01').primaryKey)]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[format('{0}-kv-{1}', variables('resourcePrefix'), parameters('uniqueSuffix'))]"
    },
    "keyVaultUri": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.KeyVault/vaults', format('{0}-kv-{1}', variables('resourcePrefix'), parameters('uniqueSuffix'))), '2023-07-01').vaultUri]"
    },
    "appInsightsConnectionString": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Insights/components', format('{0}-insights', variables('resourcePrefix'))), '2020-02-02').ConnectionString]"
    },
    "containerRegistryName": {
      "type": "string",
      "value": "[format('{0}acr{1}', replace(variables('resourcePrefix'), '-', ''), parameters('uniqueSuffix'))]"
    },
    "containerRegistryLoginServer": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', format('{0}acr{1}', replace(variables('resourcePrefix'), '-', ''), parameters('uniqueSuffix'))), '2023-07-01').loginServer]"
    },
    "containerAppEnvName": {
      "type": "string",
      "value": "[format('{0}-containerenv', variables('resourcePrefix'))]"
    }
  }
}