name: Deploy Backend to Azure Container Apps (Managed Identity)

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend-v2.yml'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AZURE_CONTAINER_REGISTRY: auditappstagingacrwgjuafflp2o4o
  RESOURCE_GROUP: auditapp-staging-rg
  CONTAINER_APP_NAME: auditapp-staging-backend
  IMAGE_NAME: auditapp-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login via Managed Identity
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Build and push to Azure Container Registry
        run: |
          echo "Building backend image..."
          az acr build \
            --registry ${{ env.AZURE_CONTAINER_REGISTRY }} \
            --image ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --image ${{ env.IMAGE_NAME }}:latest \
            --file backend/Dockerfile \
            backend/
          
          echo "‚úÖ Image built and pushed successfully"
      
      - name: Deploy to Azure Container Apps
        run: |
          echo "Deploying to Container App..."
          REVISION_SUFFIX=$(date +%s)
          
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --revision-suffix $REVISION_SUFFIX
          
          echo "‚úÖ Backend deployed successfully"
          
          # Get the new revision name
          NEW_REVISION=$(az containerapp revision list \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[0].name" -o tsv)
          
          echo "üöÄ New revision: $NEW_REVISION"
      
      - name: Verify deployment
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 10
          
          # Check health endpoint
          HEALTH_URL="https://auditapp-staging-backend.graydune-dadabae1.eastus.azurecontainerapps.io/health"
          HEALTH_STATUS=$(curl -s $HEALTH_URL | jq -r '.status')
          
          if [ "$HEALTH_STATUS" = "healthy" ]; then
            echo "‚úÖ Health check passed!"
          else
            echo "‚ö†Ô∏è Health check returned: $HEALTH_STATUS"
          fi
      
      - name: Logout from Azure
        run: az logout
        if: always()
